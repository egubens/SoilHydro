---
output: github_document
---

# **SoilHydro** — Van Genuchten Water Retention Curve Tools

**SoilHydro** is an R package for fitting **Van Genuchten** water retention curves (WRC) and deriving hydrophysical metrics. It standardizes suction units, fits per treatment/group, predicts \(\theta(h)\), computes water points (FC, PWP, AWC), partitions porosity into macro/meso/micro classes, and plots results.

-   📦 **Dependencies**: `stats`, `ggplot2`
-   🧮 **Model**: Van Genuchten (Mualem form, m = 1 - 1/n)
-   🧭 **Units**: Accepts `kPa` or `hPa` for raw data; fitting is done in kPa internally
-   🧰 **Plotting**: One WRC plot per treatment; pore-size stacked bars (percent or volume)

------------------------------------------------------------------------

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.path = "man/figures/README-",   # IMPORTANT: pkgdown reads README images from man/figures/
  out.width = "100%",
  fig.align = "center",
  fig.retina = 2
)
```

------------------------------------------------------------------------

## Installation

To install the package directly from GitHub, use:

```r
# Install from GitHub using devtools
if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools")
}
devtools::install_github("egubens/SoilHydro")
```

> Requires R ≥ 3.6; packages: **stats** (base), **ggplot2**.

------------------------------------------------------------------------

## Quick start (with simulated data)

Below we **simulate realistic WRC data** for three treatments using the Van Genuchten model, sample common suction points in **hPa**, add small measurement noise, and then run the full workflow.

```{r libraries, message=FALSE}
library(SoilHydro)
library(ggplot2)
set.seed(42)
```

```{r simulate-data}
# --------- 1) Define "true" VG parameters per treatment (kPa units) ---------
true_params <- list(
  Control     = list(theta_r = 0.05, theta_s = 0.42, alpha = 0.030, n = 1.42),
  ArtiMicro05 = list(theta_r = 0.02, theta_s = 0.44, alpha = 0.100, n = 1.55),
  Persist10   = list(theta_r = 0.04, theta_s = 0.46, alpha = 0.060, n = 1.50)
)

# --------- 2) Suction points (hPa) typical of lab WRC datasets ---------
hPa_grid <- c(1, 10, 30, 50, 75, 100, 220, 340, 440, 650, 1000, 1500, 3000, 8000, 15000)

# --------- 3) Generate data: θ(h) + noise; store as hPa for input ---------
sim_rows <- lapply(names(true_params), function(id){
  p  <- true_params[[id]]
  h_kPa <- hPa_grid / 10
  theta <- SoilHydro::vg_fun_kPa(h_kPa, p$theta_r, p$theta_s, p$alpha, p$n)
  theta_noisy <- pmin(p$theta_s, pmax(0, theta + rnorm(length(theta), sd = 0.006)))
  data.frame(Product = id, hPa = hPa_grid, theta = theta_noisy, stringsAsFactors = FALSE)
})
df <- do.call(rbind, sim_rows)

head(df)
```

```{r fit-model}
# --------- 4) Fit Van Genuchten per treatment (note: units = 'hPa') ---------
fits <- vg_fit_optim(
  data  = df,
  id    = "Product",
  theta = "theta",
  h     = "hPa",
  units = "hPa"
)
fits
```

```{r plot-wrc, fig.alt="Observed water contents and fitted Van Genuchten curve (log10 suction).", fig.cap="Observed vs fitted WRC for one treatment (Control)."}
# --------- 5) Plot WRC per treatment (log10 x-axis) ---------
plots <- plot_vg_fits(
  data      = df,
  params_df = fits,
  id        = "Product",
  theta     = "theta",
  h         = "hPa",
  units     = "hPa",
  log_x     = TRUE
)
plots[["Control"]]
```

```{r water-points}
# --------- 6) Water points: FC at 10 kPa, PWP at 1500 kPa ---------
wp <- vg_water_points(fits, id_col = "Product", fc_kPa = 10, pwp_kPa = 1500)
wp
```

```{r psd-plots, fig.alt="Pore-size distribution: percent (left) and volume (right) stacked bars by treatment.", fig.cap="Pore-size classes from VG fits."}
# --------- 7) Pore-size classes (macro/meso/micro) + stacked bar plots ---------
psd <- vg_pore_classes(
  fits,
  id_col = "Product",
  percent_basis = "theta_s",           # % of total porosity (θs)
  include_residual_in_micro = TRUE     # include θr inside "micro"
)

g_pct <- plot_pore_classes_percent(psd, id_col = "Product")
g_vol <- plot_pore_classes_volume(psd,  id_col = "Product")
g_pct
g_vol
```

------------------------------------------------------------------------

## API overview

### Fitting & prediction

-   `vg_fit_optim(data, id, theta, h, units)` — Fit VG parameters per group (or single fit if `id = NULL`).  
    **Returns**: ID, .fit_ok, theta_r, theta_s, alpha, n, m, R2, RMSE.

-   `vg_predict(params_df, id_col, new_h, units)` — Predict θ at new suctions (kPa or hPa).  
    **Returns**: ID, h, units, theta.

-   `vg_fun_kPa(h_kPa, theta_r, theta_s, alpha, n)` — Core VG function (kPa).

### Plotting

-   `plot_vg_fits(data, params_df, id, theta, h, units, log_x = TRUE)` — Observed points + fitted VG curve.
-   `plot_pore_classes_percent(psd_df, id_col, horiz = FALSE)` — Stacked **%** bars for macro/meso/micro.
-   `plot_pore_classes_volume(psd_df, id_col, horiz = FALSE)` — Stacked **volume** bars (m³ m⁻³).

### Derived metrics

-   `vg_water_points(params_df, id_col, fc_kPa = 10, pwp_kPa = 1500)` — θ at **FC** suction & PWP; **AWC** = θ_fc − θ_pwp.
-   `vg_pore_classes(params_df, id_col, d_micro_um = 10, d_macro_um = 1000, percent_basis = c("theta_s","available"), include_residual_in_micro = TRUE, return_residual = FALSE)` — Macro/meso/micro volumes and percentages.

------------------------------------------------------------------------

## Unit handling

-   Pass the **units of your raw suction column** to the fitter/plotter: `units = "kPa"` or `"hPa"`.
-   Internally, the model uses **kPa**; fitted parameters come out with α in **kPa⁻¹**.
-   Post-fit functions (`vg_water_points`, `vg_pore_classes`) assume parameters are in kPa (no `units` needed).

------------------------------------------------------------------------

## Citing the methods

- Van Genuchten, M. Th. (1980). A closed-form equation for predicting the hydraulic conductivity of unsaturated soils. *Soil Sci. Soc. Am. J.*, 44, 892–898.  
- Mualem, Y. (1976). A new model for predicting the hydraulic conductivity of unsaturated porous media. *Water Resour. Res.*, 12, 513–522.

------------------------------------------------------------------------

## Contributing

Pull requests and issues are welcome! Please include:  
- a reproducible example,  
- R version and OS,  
- session info (`sessionInfo()`), and  
- if relevant, your data snippet (or a simulated equivalent).

------------------------------------------------------------------------

## License

MIT © Erick Gutierrez / Auburn University
